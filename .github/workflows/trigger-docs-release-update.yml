name: Trigger Docs Release Update

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  notify-docs-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from release
        id: extract_version
        run: |
          # Extract version from tag (e.g., v0.9.4 -> 0.9.4)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Check if cli-metadata.json exists in release
        id: check_metadata
        run: |
          # Construct URL to cli-metadata.json in the release tag
          # Metadata should already be current from PR checklist: ./gradlew extractCliMetadata
          METADATA_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.event.release.tag_name }}/docs/cli-metadata.json"
          echo "metadata_url=${METADATA_URL}" >> $GITHUB_OUTPUT
          echo "Metadata URL: ${METADATA_URL}"

          # Verify metadata file exists in the release
          if curl --output /dev/null --silent --head --fail "${METADATA_URL}"; then
            echo "âœ“ cli-metadata.json found in release"
            echo "metadata_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš  cli-metadata.json not found in release - docs update will fail"
            echo "âš  Ensure metadata was regenerated before release (see PR template checklist)"
            echo "metadata_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Dispatch repository event to docs repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_REPO_PAT }}
          repository: seqera/docs
          event-type: cli-release
          client-payload: |
            {
              "cli_version": "${{ steps.extract_version.outputs.version }}",
              "release_tag": "${{ github.event.release.tag_name }}",
              "release_url": "${{ github.event.release.html_url }}",
              "metadata_url": "${{ steps.check_metadata.outputs.metadata_url }}",
              "metadata_exists": ${{ steps.check_metadata.outputs.metadata_exists }},
              "release_name": "${{ github.event.release.name }}",
              "release_body": ${{ toJSON(github.event.release.body) }},
              "repository": "${{ github.repository }}",
              "sender": "${{ github.event.sender.login }}"
            }

      - name: Summary
        run: |
          echo "## Docs Update Triggered ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Sent repository dispatch event to \`seqera/docs\` repository." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Payload:**" >> $GITHUB_STEP_SUMMARY
          echo "- **CLI Version:** ${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL:** ${{ github.event.release.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Metadata URL:** ${{ steps.check_metadata.outputs.metadata_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Metadata Exists:** ${{ steps.check_metadata.outputs.metadata_exists }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The docs repository will now:" >> $GITHUB_STEP_SUMMARY
          echo "1. Fetch CLI metadata from the release" >> $GITHUB_STEP_SUMMARY
          echo "2. Generate updated reference documentation" >> $GITHUB_STEP_SUMMARY
          echo "3. Create a pull request with the changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor the docs repository for the automated PR." >> $GITHUB_STEP_SUMMARY
