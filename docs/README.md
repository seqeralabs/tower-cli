# CLI Documentation Automation

This directory contains tooling and data for automated CLI documentation generation and maintenance.

## Overview

The tower-cli documentation automation uses Java reflection to extract command metadata from picocli annotations, providing structured data for the docs repository to generate comprehensive CLI reference documentation.

## Components

### cli-metadata.json

Structured metadata for all CLI commands extracted using Java reflection from picocli's CommandSpec API.

**Contains:**
- Complete command hierarchy (5+ levels deep)
- All options with descriptions, defaults, arity, types
- Positional parameters
- Automatically resolved mixin classes
- Hidden commands and options

**Generated by:** `./gradlew extractCliMetadata` (runs `CliMetadataExtractor.java`)

**Update frequency:** Run before merging any PR that modifies CLI commands or options (enforced via PR template checklist)

**Usage:** Consumed by docs repository to generate command reference pages

### seqera-api-latest-decorated.yaml

OpenAPI specification with overlay decorations for the Seqera Platform API.

**Usage:** Reference for CLI option enrichment (CLI options often map to API fields)

**Source:** Fetched from docs repository

**Update frequency:** When API documentation updates

## Metadata Extraction

### Java Reflection Approach

The metadata extractor uses picocli's CommandSpec API for deterministic extraction:

```bash
./gradlew extractCliMetadata
```

**Benefits over text-based parsing:**
- **Deterministic:** Same input always produces same output
- **Complete:** Captures 966+ options (vs 461 with regex parsing)
- **Automatic mixin resolution:** No manual handling needed
- **Type information:** Full Java type details (String, boolean, enums, etc.)
- **Maintained by build:** No separate Python dependency

**Implementation:** `src/main/java/io/seqera/tower/cli/utils/metadata/CliMetadataExtractor.java`

**How it works:**
1. Instantiates the Tower CLI application
2. Uses picocli CommandSpec API to walk the command tree
3. Extracts metadata for all commands, options, and parameters
4. Resolves all @Mixin annotations automatically
5. Outputs formatted JSON to `docs/cli-metadata.json`

## Architecture

### Metadata Extraction Flow

```
Java Source Files (@Command, @Option annotations)
         ↓
    Compile with javac
         ↓
Java Reflection (CommandSpec API)
         ↓
CliMetadataExtractor.java (walks command tree)
         ↓
cli-metadata.json (structured command data)
         ↓
Docs Repository (generates markdown reference pages)
```

### CLI Option Enrichment Pattern

**Problem:** CLI help text quality varied (terse descriptions, inconsistent terminology)

**Solution:** Systematic enrichment using API documentation as quality baseline

**Process:**
1. Identify CLI options that map to API request fields
2. Reference OpenAPI spec descriptions for technical accuracy
3. Adapt descriptions for CLI context (add examples, prerequisites, command refs)
4. Apply quality standards (technical precision, practical guidance, security context)
5. Update `@Option` descriptions directly in Java source files
6. Re-run metadata extraction to capture enriched descriptions

**Status:** 624+ option descriptions enriched across 185 files

**Tool:** Use `/enrich-cli-help` Claude Code skill for systematic enrichment workflow

## Release Automation

### Workflow Process

1. **During Development:**
   - Developers add/modify CLI commands and options in Java source
   - Improve `@Option` descriptions using enrichment standards

2. **Before Merging PR:**
   - Developer runs `./gradlew extractCliMetadata` to regenerate metadata
   - Commits updated `docs/cli-metadata.json`
   - PR template checklist ensures this step is completed

3. **On Release:**
   - GitHub Actions workflow triggers on `release.published` event
   - Verifies `cli-metadata.json` exists in the release tag
   - Sends repository dispatch to docs repository with:
     - CLI version
     - Release tag and URL
     - Metadata file URL
     - Release notes

4. **Docs Repository:**
   - Receives `cli-release` event
   - Fetches `cli-metadata.json` from tower-cli release
   - Generates updated CLI reference documentation
   - Creates automated PR with changes

**Result:** Zero manual documentation steps after CLI release

**Workflow:** `.github/workflows/trigger-docs-release-update.yml`

## Quality Standards

All enriched CLI option descriptions follow these criteria:

### Technical Precision
- Specify data types, formats, units
- Document constraints and validation rules
- Explain technical requirements clearly

**Example:**
```java
// Before
@Option(names = {"--max"}, description = "Maximum results")

// After
@Option(names = {"--max"}, description = "Maximum number of results to return (1-100). Default: 10.")
```

### Practical Guidance
- Include realistic examples
- Reference related commands
- Document prerequisites and dependencies

**Example:**
```java
// Before
@Option(names = {"--work-dir"}, description = "Work directory")

// After
@Option(names = {"--work-dir"}, description = "S3 bucket path where Nextflow writes temporary files and task work directories (e.g., s3://your-bucket/work). Must be accessible with the configured AWS credentials. Defaults to compute environment work directory if omitted.")
```

### Security Context
- Warn about sensitive fields
- Document data loss implications
- Clarify access requirements

**Example:**
```java
// Before
@Option(names = {"--token"}, description = "Access token")

// After
@Option(names = {"--token"}, description = "Personal access token for authentication. Token will be stored securely and never logged. Required scopes: workflow:read, workspace:read.")
```

## Contributor Guide

### When CLI Commands/Options Change

Always update metadata before merging:

```bash
# Make your CLI changes in Java source files
# Improve @Option descriptions following quality standards
# Then regenerate metadata
./gradlew extractCliMetadata

# Commit both changes
git add docs/cli-metadata.json src/main/java/**/*.java
git commit -m "Add [feature]: Update CLI metadata"
```

### PR Checklist

The PR template includes a checklist item:

- [ ] **CLI metadata updated** (if CLI commands/options were added/modified)
  - [ ] Ran `./gradlew extractCliMetadata` to regenerate `docs/cli-metadata.json`
  - [ ] Committed the updated metadata file

This ensures metadata stays synchronized with code changes.

### Enriching CLI Help Text

Use the `/enrich-cli-help` Claude Code skill for systematic enrichment:

```bash
/enrich-cli-help [command-family-name]
```

**Example:** `/enrich-cli-help pipelines`

The skill automates a proven workflow:
1. Parallel agent research (codebase patterns, API mappings)
2. Synthesis & planning (architecture patterns, enrichment strategy)
3. Manual enrichment (apply quality standards)
4. Verification & commit (review changes, statistics)

**Documentation:** See `.claude/skills/enrich-cli-help/` for complete workflow guide

## Troubleshooting

### Metadata Extraction Issues

**Problem:** Build fails with "Username must not be null!"

**Solution:** Configure GitHub credentials for private tower-java-sdk dependency:
```bash
# In ~/.gradle/gradle.properties
github.packages.user=your-github-username
github.packages.token=your-github-token
```

**Problem:** Commands missing from output

**Solution:** Check for:
- Proper `@Command` annotation on class
- Parent command has `subcommands = {ChildCmd.class}` reference
- Import statement if subcommand in different package

**Problem:** Options missing from command

**Solution:**
- Ensure mixin classes are properly annotated with `@Mixin`
- Verify option annotations: `@Option` or `@CommandLine.Option` (both supported)
- Check that picocli can access the option at runtime

## Metrics

### Current State (Java Reflection)
- **Commands extracted:** 162
- **Options extracted:** 966
- **Parameters extracted:** 12
- **Mixin resolution:** Automatic
- **Type information:** Complete Java types
- **Deterministic:** Yes

### Previous State (Python Regex)
- **Commands extracted:** 163
- **Options extracted:** 461 (53% fewer!)
- **Mixin resolution:** Partial (manual)
- **Type information:** Limited
- **Deterministic:** No (brittle regex patterns)

### Quality Impact
- **Options enriched:** 624+ descriptions
- **Files improved:** 185 Java source files
- **Quality standard:** OpenAPI-grade technical precision
- **Time savings:** Automated docs updates on every release

## Related Documentation

- **Java extractor:** `src/main/java/io/seqera/tower/cli/utils/metadata/CliMetadataExtractor.java`
- **Gradle task:** `extractCliMetadata` in `build.gradle`
- **PR template:** `.github/pull_request_template.md`
- **Release workflow:** `.github/workflows/trigger-docs-release-update.yml`
- **Claude Code skill:** `.claude/skills/enrich-cli-help/SKILL.md`
- **Quality standards:** `.claude/skills/enrich-cli-help/references/quality-standards.md`
- **Architecture patterns:** `.claude/skills/enrich-cli-help/references/architecture-patterns.md`
- **API documentation:** https://docs.seqera.io/platform/latest/api/overview
- **CLI documentation:** https://docs.seqera.io/platform/latest/cli/overview
